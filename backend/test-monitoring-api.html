<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Liquidity Monitoring Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .api-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .token {
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            position: relative;
            cursor: pointer;
        }
        .token:hover {
            background: #f0f0f0;
        }
        .token-header {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .liquidity-changes {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .change-item {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
        }
        .positive {
            background: #d4edda;
            color: #155724;
        }
        .negative {
            background: #f8d7da;
            color: #721c24;
        }
        .neutral {
            background: #e2e3e5;
            color: #383d41;
        }
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tooltip.visible {
            opacity: 1;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .json-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç API Liquidity Monitoring Test</h1>
        
        <div class="api-section">
            <h2>API Response Testing</h2>
            <button onclick="fetchAPIData()">Fetch Wallet Tokens</button>
            <button onclick="fetchMonitoredToken()">Fetch Monitored Token</button>
            <button onclick="autoRefresh()">Auto Refresh (10s)</button>
            <button onclick="stopAutoRefresh()">Stop Auto Refresh</button>
            
            <div id="status"></div>
            <div id="api-results"></div>
        </div>

        <div class="api-section">
            <h2>Token UI Display Test</h2>
            <div id="token-display"></div>
        </div>

        <div class="api-section">
            <h2>Liquidity Change Verification</h2>
            <div id="verification-results"></div>
        </div>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <script>
        let autoRefreshInterval = null;
        let lastFetchTime = null;
        let apiData = null;

        const walletAddress = '6PP4BH39zThbjRU8XhJ9AwXRqPyGjqCxwftemXYXSwvG';
        const monitoredToken = 'Gvn6RiUgXe5mhdsfxG99WPaE4tA5B34cSfuKz1bDpump';
        const apiUrl = `http://localhost:3001/api/wallet/tokens/${walletAddress}`;
        const tokenApiUrl = `http://localhost:3001/api/tokens/${monitoredToken}`;

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        function formatPercentage(value) {
            if (value === 0 || value === null || value === undefined) return '0.00%';
            const sign = value > 0 ? '‚ñ≤' : '‚ñº';
            return `${sign} ${Math.abs(value).toFixed(2)}%`;
        }

        function getChangeClass(value) {
            if (value > 0) return 'positive';
            if (value < 0) return 'negative';
            return 'neutral';
        }

        async function fetchAPIData() {
            showStatus('üîÑ Fetching wallet tokens API data...', 'warning');
            lastFetchTime = new Date();

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} - ${JSON.stringify(data)}`);
                }

                apiData = data;
                displayAPIResults(data);
                displayTokenUI(data);
                verifyLiquidityChanges(data);

                showStatus(`‚úÖ Wallet Tokens API data fetched successfully at ${lastFetchTime.toLocaleTimeString()}`, 'success');

            } catch (error) {
                showStatus(`‚ùå Error fetching wallet tokens API data: ${error.message}`, 'error');
                console.error('API fetch error:', error);
            }
        }

        async function fetchMonitoredToken() {
            showStatus('üîÑ Fetching monitored token API data...', 'warning');
            lastFetchTime = new Date();

            try {
                const response = await fetch(tokenApiUrl);
                const tokenData = await response.json();

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} - ${JSON.stringify(tokenData)}`);
                }

                apiData = {tokens: [tokenData]};
                displayTokenUI(apiData);
                verifyLiquidityChanges(apiData);

                showStatus(`‚úÖ Monitored token API data fetched successfully at ${lastFetchTime.toLocaleTimeString()}`, 'success');

            } catch (error) {
                showStatus(`‚ùå Error fetching monitored token API data: ${error.message}`, 'error');
                console.error('API fetch error:', error);
            }
        }

        function displayAPIResults(data) {
            const resultsDiv = document.getElementById('api-results');
            
            const tokensWithPrices = data.tokens?.filter(token => token.token_prices) || [];
            
            let html = `
                <h3>üìä API Response Summary</h3>
                <p><strong>Total tokens:</strong> ${data.tokens?.length || 0}</p>
                <p><strong>Tokens with price data:</strong> ${tokensWithPrices.length}</p>
                
                <h4>Raw JSON Response (First 3 tokens):</h4>
                <div class="json-output">
                    ${JSON.stringify(tokensWithPrices.slice(0, 3), null, 2)}
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function displayTokenUI(data) {
            const displayDiv = document.getElementById('token-display');
            
            // Handle both single token response and array of tokens
            let tokens = [];
            if (data.tokens && Array.isArray(data.tokens)) {
                tokens = data.tokens;
            } else if (data.mint) {
                // Single token response
                tokens = [data];
            }
            
            const tokensWithPrices = tokens.filter(token => token.price || token.token_prices) || [];
            
            if (tokensWithPrices.length === 0) {
                displayDiv.innerHTML = '<p>No tokens with price data found.</p>';
                return;
            }

            let html = '<h3>ü™ô Token Display (Hover for tooltip)</h3>';
            
            tokensWithPrices.slice(0, 5).forEach(token => {
                // Handle different response structures
                const prices = token.price || token.token_prices || {};
                const change1m = prices.liquidity_change_1m || 0;
                const change5m = prices.liquidity_change_5m || 0;
                const change30m = prices.liquidity_change_30m || 0;
                
                html += `
                    <div class="token" data-token='${JSON.stringify(token)}' onmouseover="showTooltip(event, this)" onmouseout="hideTooltip()">
                        <div class="token-header">
                            ${token.symbol} - ${token.name}
                        </div>
                        <div>
                            <strong>Current Liquidity:</strong> $${(prices.liquidity || token.current_liquidity || 0).toFixed(2)}
                        </div>
                        <div>
                            <strong>Current Price:</strong> $${(prices.price || token.current_price || 0).toFixed(8)}
                        </div>
                        <div class="liquidity-changes">
                            <div class="change-item ${getChangeClass(change1m)}">
                                1m: ${formatPercentage(change1m)}
                            </div>
                            <div class="change-item ${getChangeClass(change5m)}">
                                5m: ${formatPercentage(change5m)}
                            </div>
                            <div class="change-item ${getChangeClass(change30m)}">
                                30m: ${formatPercentage(change30m)}
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <strong>Debug Info:</strong><br>
                            ‚Ä¢ Market Cap: $${(token.market_cap || 0).toFixed(2)}<br>
                            ‚Ä¢ 24h Volume: $${(prices.volume_24h || token.volume_24h || 0).toFixed(2)}<br>
                            ‚Ä¢ 24h Change: ${formatPercentage(prices.change_24h || token.price_24h_change || 0)}
                        </div>
                    </div>
                `;
            });
            
            displayDiv.innerHTML = html;
        }

        function showTooltip(event, element) {
            const tooltip = document.getElementById('tooltip');
            const tokenData = JSON.parse(element.dataset.token);
            const prices = tokenData.price || tokenData.token_prices || {};
            
            const change1m = prices.liquidity_change_1m || 0;
            const change5m = prices.liquidity_change_5m || 0;
            const change30m = prices.liquidity_change_30m || 0;
            
            tooltip.innerHTML = `
                <strong>${tokenData.symbol}</strong><br>
                Liquidity Changes (per minute):<br>
                ‚Ä¢ 1m: ${formatPercentage(change1m)}<br>
                ‚Ä¢ 5m: ${formatPercentage(change5m)}<br>
                ‚Ä¢ 30m: ${formatPercentage(change30m)}<br>
                Current: $${(prices.liquidity || tokenData.current_liquidity || 0).toFixed(2)}<br>
                Price: $${(prices.price || tokenData.current_price || 0).toFixed(8)}
            `;
            
            tooltip.style.left = event.pageX + 10 + 'px';
            tooltip.style.top = event.pageY + 10 + 'px';
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            const tooltip = document.getElementById('tooltip');
            tooltip.classList.remove('visible');
        }

        function verifyLiquidityChanges(data) {
            const verificationDiv = document.getElementById('verification-results');
            const tokensWithPrices = data.tokens?.filter(token => token.token_prices) || [];
            
            let verificationResults = [];
            let hasNonZeroChanges = false;
            
            tokensWithPrices.forEach(token => {
                const prices = token.token_prices;
                const change1m = prices.liquidity_change_1m || 0;
                const change5m = prices.liquidity_change_5m || 0;
                const change30m = prices.liquidity_change_30m || 0;
                
                if (change1m !== 0 || change5m !== 0 || change30m !== 0) {
                    hasNonZeroChanges = true;
                    verificationResults.push({
                        symbol: token.symbol,
                        change1m,
                        change5m,
                        change30m
                    });
                }
            });
            
            let html = '<h3>‚úÖ Verification Results</h3>';
            
            if (hasNonZeroChanges) {
                html += `
                    <div class="status success">
                        ‚úÖ SUCCESS: Found ${verificationResults.length} tokens with non-zero liquidity changes!
                    </div>
                    <h4>Tokens with changes:</h4>
                `;
                
                verificationResults.forEach(result => {
                    html += `
                        <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <strong>${result.symbol}:</strong><br>
                            ‚Ä¢ 1m: ${formatPercentage(result.change1m)}<br>
                            ‚Ä¢ 5m: ${formatPercentage(result.change5m)}<br>
                            ‚Ä¢ 30m: ${formatPercentage(result.change30m)}
                        </div>
                    `;
                });
                
                // Regression test assertion
                const change5mNonZero = verificationResults.some(r => r.change5m !== 0);
                html += `
                    <div class="status ${change5mNonZero ? 'success' : 'error'}">
                        üß™ Regression Test: change5m !== 0 - ${change5mNonZero ? 'PASS' : 'FAIL'}
                    </div>
                `;
                
            } else {
                html += `
                    <div class="status warning">
                        ‚ö†Ô∏è No tokens with non-zero liquidity changes found.<br>
                        This may be expected if:<br>
                        ‚Ä¢ Price polling service hasn't been running long enough<br>
                        ‚Ä¢ No significant liquidity changes have occurred<br>
                        ‚Ä¢ Token price history is empty
                    </div>
                `;
            }
            
            verificationDiv.innerHTML = html;
        }

        function autoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            fetchAPIData(); // Fetch immediately
            autoRefreshInterval = setInterval(fetchAPIData, 10000); // Then every 10 seconds
            showStatus('üîÑ Auto-refresh enabled (every 10 seconds)', 'warning');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                showStatus('‚èπÔ∏è Auto-refresh stopped', 'info');
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('üìã Page loaded. Click "Fetch API Data" to begin testing.', 'info');
        });
    </script>
</body>
</html>
