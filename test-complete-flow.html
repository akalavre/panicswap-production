<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Flow Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/config.js"></script>
    <script src="assets/js/backend-config.js"></script>
    <script src="assets/js/supabase-client.js"></script>
    <script src="assets/js/supabase-token-fetcher.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .step { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Complete Token Price Flow Test</h1>
    
    <div id="steps"></div>
    
    <script>
        const steps = document.getElementById('steps');
        
        function addStep(title, content, type = 'info') {
            const step = document.createElement('div');
            step.className = `step ${type}`;
            step.innerHTML = `<h3>${title}</h3><div>${content}</div>`;
            steps.appendChild(step);
        }
        
        async function runTest() {
            // Step 1: Check backend connectivity
            addStep('Step 1: Backend Connectivity', 'Checking backend at ' + window.BACKEND_URL);
            
            try {
                const testResponse = await fetch(`${window.BACKEND_URL}/api/dashboard/test`);
                const testData = await testResponse.json();
                addStep('Backend Connected', 'Response: ' + JSON.stringify(testData), 'success');
            } catch (error) {
                addStep('Backend Connection Failed', error.message, 'error');
                return;
            }
            
            // Step 2: Check Supabase connectivity
            addStep('Step 2: Supabase Connectivity', 'Testing Supabase connection...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('token_metadata')
                    .select('*')
                    .limit(1);
                    
                if (error) throw error;
                addStep('Supabase Connected', 'Successfully queried token_metadata table', 'success');
            } catch (error) {
                addStep('Supabase Connection Failed', error.message, 'error');
                return;
            }
            
            // Step 3: Load tokens from Supabase
            addStep('Step 3: Loading Tokens', 'Fetching tokens for wallet...');
            
            let tokens = [];
            try {
                const walletAddress = localStorage.getItem('walletAddress') || '6PP4BH39zThbjRU8XhJ9AwXRqPyGjqCxwftemXYXSwvG';
                tokens = await window.SupabaseTokenFetcher.fetchDashboardTokens(walletAddress);
                
                addStep('Tokens Loaded', `Found ${tokens.length} tokens`, 'success');
                
                // Show sample token data
                if (tokens.length > 0) {
                    const sampleToken = tokens[0];
                    addStep('Sample Token Data', `<pre>${JSON.stringify({
                        symbol: sampleToken.symbol,
                        mint: sampleToken.token_mint,
                        price: sampleToken.price,
                        balance: sampleToken.balance,
                        value: sampleToken.value
                    }, null, 2)}</pre>`, 'info');
                }
            } catch (error) {
                addStep('Token Loading Failed', error.message, 'error');
                return;
            }
            
            // Step 4: Register tokens with backend
            addStep('Step 4: Backend Registration', 'Registering tokens with backend...');
            
            try {
                const tokenMints = tokens.map(t => t.token_mint);
                const response = await fetch(`${window.BACKEND_URL}/api/dashboard/register-tokens`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        walletAddress: localStorage.getItem('walletAddress') || '6PP4BH39zThbjRU8XhJ9AwXRqPyGjqCxwftemXYXSwvG',
                        tokenMints: tokenMints
                    })
                });
                
                const regData = await response.json();
                addStep('Registration Successful', 'Response: ' + JSON.stringify(regData), 'success');
            } catch (error) {
                addStep('Registration Failed', error.message, 'error');
            }
            
            // Step 5: Check backend prices after delay
            addStep('Step 5: Backend Price Check', 'Waiting 3 seconds for price polling...');
            
            setTimeout(async () => {
                try {
                    const pricesResponse = await fetch(`${window.BACKEND_URL}/api/dashboard/check-prices`);
                    const pricesData = await pricesResponse.json();
                    
                    addStep('Backend Prices', `Found ${pricesData.count} prices in backend`, 'success');
                    
                    if (pricesData.prices && pricesData.prices.length > 0) {
                        const priceList = pricesData.prices.slice(0, 5).map(p => 
                            `${p.token_mint.substring(0, 8)}... = $${p.price}`
                        ).join('<br>');
                        addStep('Sample Prices', priceList, 'info');
                    }
                } catch (error) {
                    addStep('Price Check Failed', error.message, 'error');
                }
                
                // Step 6: Check Supabase prices directly
                addStep('Step 6: Direct Supabase Check', 'Querying token_prices table...');
                
                try {
                    const { data: dbPrices, error } = await supabaseClient
                        .from('token_prices')
                        .select('*')
                        .in('token_mint', tokens.map(t => t.token_mint).slice(0, 5))
                        .limit(5);
                    
                    if (error) throw error;
                    
                    addStep('Supabase Prices', `Found ${dbPrices.length} prices in database`, 'success');
                    
                    if (dbPrices.length > 0) {
                        addStep('Database Price Sample', `<pre>${JSON.stringify(dbPrices[0], null, 2)}</pre>`, 'info');
                    }
                } catch (error) {
                    addStep('Supabase Query Failed', error.message, 'error');
                }
                
                // Step 7: Test real-time subscription
                addStep('Step 7: Real-time Subscription', 'Setting up price update subscription...');
                
                try {
                    const channel = supabaseClient
                        .channel('test-price-updates')
                        .on('postgres_changes', {
                            event: '*',
                            schema: 'public',
                            table: 'token_prices'
                        }, (payload) => {
                            addStep('Real-time Update Received!', `<pre>${JSON.stringify(payload, null, 2)}</pre>`, 'success');
                        })
                        .subscribe((status) => {
                            if (status === 'SUBSCRIBED') {
                                addStep('Subscription Active', 'Listening for price updates...', 'success');
                            }
                        });
                    
                    // Cleanup after 30 seconds
                    setTimeout(() => {
                        channel.unsubscribe();
                        addStep('Test Complete', 'Subscription cleaned up', 'info');
                    }, 30000);
                    
                } catch (error) {
                    addStep('Subscription Failed', error.message, 'error');
                }
                
            }, 3000);
        }
        
        // Run test on load
        runTest();
    </script>
</body>
</html>